import{n as r,b as h,L as p,B as f,S as m,_ as v,D as $,C as y}from"../build.js";import{K as g}from"./KeywordsField-B8AZHPAc.js";import{F as k}from"./FileShown-kVHowmAA.js";import{D as w}from"./DestinationCorpusSelector-D9gmIUpK.js";import{T as _}from"./TwoColumnLayout-B4qoL0VK.js";const b={props:{shared_files:Array,group_mode:String,sort_order:String,author_path_filter:String,available_keywords:Array,keywords_filter:Array},components:{SingleKeyword:h},data(){return{all_authors:[],keyword_search:"",expanded_categories:{},initial_keywords_limit:5,group_options:[{key:"day",label:this.$t("day")},{key:"month",label:this.$t("month")},{key:"year",label:this.$t("year")}],type_of_media_to_display:"all",types_of_medias:[{key:"all",label:this.$t("all_medias_types")},{key:"image",label:this.$t("image")},{key:"video",label:this.$t("video")},{key:"audio",label:this.$t("audio")},{key:"text",label:this.$t("text")},{key:"pdf",label:this.$t("pdf")},{key:"stl",label:this.$t("stl")},{key:"other",label:this.$t("other")}]}},i18n:{messages:{fr:{show_more:"Afficher plus",show_less:"Afficher moins"},en:{show_more:"Show more",show_less:"Show less"}}},async created(){this.all_authors=await this.$api.getFolders({path:"authors"})},async mounted(){},beforeDestroy(){},watch:{},computed:{keywords_by_category(){const s={};return this.available_keywords.forEach(t=>{const e=this.getKeywordName(t.title);if(this.keyword_search&&!e.toLowerCase().includes(this.keyword_search.toLowerCase()))return;const a=this.getKeywordCategory(t.title)||"OTHER";s[a]||(s[a]={type:a,keywords:[]}),s[a].keywords.push(t)}),Object.keys(s).sort().map(t=>({type:t,keywords:s[t].keywords.sort((e,i)=>i.count!==e.count?i.count-e.count:this.getKeywordName(e.title).localeCompare(this.getKeywordName(i.title)))}))},can_be_reset(){return this.group_mode!=="year"||this.sort_order!=="date_modified"||this.author_path_filter!==""||this.keywords_filter.length>0}},methods:{resetFilters(){this.$emit("update:group_mode","year"),this.$emit("update:sort_order","date_modified"),this.$emit("update:author_path_filter",""),this.$emit("update:keywords_filter",[]),this.keyword_search=""},getKeywordCategory(s){return s.includes("/")?s.split("/")[0]:null},getKeywordName(s){return s.includes("/")?s.split("/")[1]:s},isKeywordSelected(s){return this.keywords_filter.includes(s)},toggleKeyword(s,t){let e=this.keywords_filter.slice();t?e.includes(s)||e.push(s):e=e.filter(i=>i!==s),this.$emit("update:keywords_filter",e)},getCategoryColorStyle(s){var e;if(!s||!((e=window.app_infos)!=null&&e.custom_suggested_categories))return"";const t=window.app_infos.custom_suggested_categories.find(i=>i.title===s);return t!=null&&t.tag_color?`--cat-color: ${t.tag_color}`:""},getCategoryColor(s){var e;if(!s||!((e=window.app_infos)!=null&&e.custom_suggested_categories))return;const t=window.app_infos.custom_suggested_categories.find(i=>i.title===s);return t==null?void 0:t.tag_color},displayedKeywords(s){return this.isCategoryExpanded(s.type)||this.keyword_search.length>0?s.keywords:s.keywords.slice(0,this.initial_keywords_limit)},shouldShowMoreButton(s){return this.keyword_search.length>0?!1:s.keywords.length>this.initial_keywords_limit},isCategoryExpanded(s){return this.expanded_categories[s]===!0},toggleCategoryExpansion(s){this.$set(this.expanded_categories,s,!this.expanded_categories[s])}}};var C=function(){var t=this,e=t._self._c;return e("div",{staticClass:"_filterBar"},[e("div",{staticClass:"_filterPane"},[e("div",{staticClass:"_topRow"},[e("h2",{staticClass:"_filterTitle"},[t._v(t._s(t.$t("filters")))]),e("button",{staticClass:"u-buttonLink _closeBtn",attrs:{type:"button"},on:{click:function(i){return t.$emit("close")}}},[e("b-icon",{attrs:{icon:"x"}})],1)]),e("div",{staticClass:"_filterSection"},[e("div",{staticClass:"_sectionTitle"},[t._v(t._s(t.$t("sort_by")))]),e("div",{staticClass:"_radioGroup"},[e("label",{staticClass:"_radioLabel"},[e("input",{attrs:{type:"radio",value:"date_modified"},domProps:{checked:t.sort_order==="date_modified"},on:{change:function(i){return t.$emit("update:sort_order","date_modified")}}}),e("span",{staticClass:"_radioText"},[t._v(t._s(t.$t("date_modified")))])]),e("label",{staticClass:"_radioLabel"},[e("input",{attrs:{type:"radio",value:"date_created"},domProps:{checked:t.sort_order==="date_created"},on:{change:function(i){return t.$emit("update:sort_order","date_created")}}}),e("span",{staticClass:"_radioText"},[t._v(t._s(t.$t("date_created")))])])])]),e("div",{staticClass:"_filterSection"},[e("div",{staticClass:"_sectionTitle"},[t._v(t._s(t.$t("group_by_date")))]),e("select",{staticClass:"_selectField",domProps:{value:t.group_mode},on:{change:function(i){return t.$emit("update:group_mode",i.target.value)}}},t._l(t.group_options,function(i){return e("option",{key:i.key,domProps:{value:i.key,textContent:t._s(i.label)}})}),0)]),e("div",{staticClass:"_filterSection"},[e("div",{staticClass:"_sectionTitle"},[t._v(t._s(t.$t("filter_by_author")))]),e("select",{staticClass:"_selectField",domProps:{value:t.author_path_filter},on:{change:function(i){return t.$emit("update:author_path_filter",i.target.value)}}},[e("option",{attrs:{value:""},domProps:{textContent:t._s(t.$t("none"))}}),t._l(t.all_authors,function(i){return e("option",{key:i.$path,domProps:{value:i.$path,textContent:t._s(i.name)}})})],2)]),e("div",{staticClass:"_filterSection"},[e("div",{staticClass:"_tag"},[e("DLabel",{attrs:{str:t.$t("filter_by_keyword")}}),e("input",{directives:[{name:"model",rawName:"v-model",value:t.keyword_search,expression:"keyword_search"}],staticClass:"_searchField",attrs:{type:"text",placeholder:t.$t("search")},domProps:{value:t.keyword_search},on:{input:function(i){i.target.composing||(t.keyword_search=i.target.value)}}}),t._l(t.keywords_by_category,function(i){return e("div",{key:i.type,staticClass:"_keywordCategory"},[e("div",{staticClass:"_categoryHeader"},[t._v(" "+t._s(i.type)+" ")]),e("div",{staticClass:"_keywordCheckboxes"},[t._l(t.displayedKeywords(i),function(a){return e("label",{key:a.title,staticClass:"u-keywords _keywordCheckbox"},[e("input",{attrs:{type:"checkbox"},domProps:{checked:t.isKeywordSelected(a.title)},on:{change:function(o){return t.toggleKeyword(a.title,o.target.checked)}}}),e("SingleKeyword",{attrs:{keyword:a.title,show_category:!1,count:a.count,cat_color:t.getCategoryColor(i.type)}})],1)}),t.shouldShowMoreButton(i)?e("button",{staticClass:"u-buttonLink _showMoreButton",attrs:{type:"button"},on:{click:function(a){return t.toggleCategoryExpansion(i.type)}}},[t.isCategoryExpanded(i.type)?[t._v(" "+t._s(t.$t("show_less"))+" ")]:[t._v(" "+t._s(t.$t("show_more"))+" ("+t._s(i.keywords.length-t.initial_keywords_limit)+") ")],e("b-icon",{attrs:{icon:t.isCategoryExpanded(i.type)?"chevron-up":"chevron-down"}})],2):t._e()],2)])})],2)])]),t.can_be_reset?e("div",{staticClass:"_resetFilters"},[e("button",{staticClass:"u-button u-button_black u-button_pill",attrs:{type:"button"},on:{click:t.resetFilters}},[t._v(" "+t._s(t.$t("reset"))+" ")])]):t._e()])},S=[],F=r(b,C,S,!1,null,"0bf5bea0");const x=F.exports,M={props:{stack:Object,is_selected:Boolean,is_favorite:Boolean,can_be_added_to_fav:Boolean,display:String},components:{},data(){return{start_slide:!1,stack_files:void 0,index_of_slide_file_to_show:void 0,is_being_opened:!1}},i18n:{messages:{fr:{}}},created(){},mounted(){},beforeDestroy(){},watch:{},computed:{number_of_medias_in_stack(){var s;return((s=this.stack.stack_files_metas)==null?void 0:s.length)||0},slide_file_to_show(){return this.stack_files&&this.index_of_slide_file_to_show!==void 0?this.stack_files[this.index_of_slide_file_to_show]:!1}},methods:{openStack(){const s=this.getFilename(this.stack.$path),t=this.index_of_slide_file_to_show;this.is_being_opened=!0,setTimeout(()=>{this.is_being_opened=!1},500),this.$emit("openStack",s,t)},async startSlide(s){this.start_slide=!0,setTimeout(async()=>{if(this.start_slide){const t=await this.loadFiles();this.stack_files=t,this.updateMousePos(s)}},200)},updateMousePos(s){if(!this.stack_files)return;const{pageX:t}=s,{x:e,width:i}=this.$el.getBoundingClientRect(),a=(t-e)/i;this.index_of_slide_file_to_show=Math.floor(a*this.number_of_medias_in_stack)},endSlide(){this.is_being_opened||(this.start_slide=!1,this.stack_files=void 0,this.index_of_slide_file_to_show=void 0)},async loadFiles(){const s=await this.$api.getFolder({path:this.stack.$path});return this.getStackFilesInOrder({stack:s})}}};var L=function(){var t=this,e=t._self._c;return e("div",{staticClass:"_stackPreview",style:{},on:{mouseenter:t.startSlide,mousemove:t.updateMousePos,mouseleave:t.endSlide}},[e("button",{staticClass:"_stackPreview--content",class:{"is--slider":t.start_slide,"is--selected":t.is_selected,"is--compact":t.display==="compact"},attrs:{type:"button",title:t.stack.title},on:{click:t.openStack}},[e("div",{staticClass:"_preview"},[e("div",{key:"preview",staticClass:"_mainPreview",class:{"is--showingSlides":t.slide_file_to_show}},[t.stack.$preview?e("MediaContent",{staticClass:"_mediaPreview",attrs:{file:t.stack.$preview}}):e("b-icon",{attrs:{icon:"eye-slash"}})],1),t._l(t.stack_files,function(i){var a;return e("div",{key:i.$path,staticClass:"_slide",class:{"is--shown":i.$path===((a=t.slide_file_to_show)==null?void 0:a.$path)}},[e("MediaContent",{staticClass:"_mediaPreview",attrs:{file:i}})],1)}),e("transition",{attrs:{name:"fade_fast",mode:"out-in"}},[t.start_slide&&t.number_of_medias_in_stack>0?e("div",{staticClass:"_count"},[t.index_of_slide_file_to_show!==void 0?[t._v(" "+t._s(t.index_of_slide_file_to_show+1)+" / "+t._s(t.number_of_medias_in_stack)+" ")]:[t._v(" "+t._s(t.number_of_medias_in_stack)+" ")]],2):t._e()]),e("button",{staticClass:"u-button u-button_icon u-button_transparent _addToFav",attrs:{type:"button","data-isfav":t.is_favorite,disabled:!t.can_be_added_to_fav},on:{click:function(i){return i.stopPropagation(),t.$emit("toggleFav")}}},[e("svg",{attrs:{width:"16",height:"16",viewBox:"0 0 16 16",xmlns:"http://www.w3.org/2000/svg"}},[e("path",{attrs:{d:"M7.38174 1.75501C7.59507 1.19234 8.40241 1.19234 8.61641 1.75501L9.99641 5.57767C10.0931 5.83101 10.3391 5.99967 10.6137 5.99967H14.0051C14.6317 5.99967 14.9051 6.77967 14.4124 7.16167L11.9991 9.33301C11.891 9.41611 11.812 9.53132 11.7734 9.66211C11.7348 9.7929 11.7387 9.93255 11.7844 10.061L12.6657 13.7963C12.8804 14.3963 12.1857 14.9117 11.6604 14.5423L8.38241 12.4623C8.27015 12.3834 8.13628 12.3411 7.99907 12.3411C7.86187 12.3411 7.728 12.3834 7.61574 12.4623L4.33774 14.5423C3.81307 14.9117 3.11774 14.3957 3.33241 13.7963L4.21374 10.061C4.25946 9.93255 4.26331 9.7929 4.22475 9.66211C4.18618 9.53132 4.10718 9.41611 3.99907 9.33301L1.58574 7.16167C1.09241 6.77967 1.36707 5.99967 1.99241 5.99967H5.38374C5.51727 6.00012 5.64778 5.96001 5.75802 5.88466C5.86825 5.8093 5.95301 5.70225 6.00107 5.57767L7.38107 1.75501H7.38174Z","stroke-linecap":"round","stroke-linejoin":"round"}})])])],2),t.display!=="compact"?e("div",{staticClass:"_title"},[t._v(" "+t._s(t.stack.title)+" ")]):t._e()])])},A=[],B=r(M,L,A,!1,null,"d5ef6427");const I=B.exports,T={props:{files:Array,can_edit:Boolean,can_be_selected:[Boolean,String],selected_files:Array},components:{FileShown:k},data(){return{active_file_index:0,is_dragged:!1}},i18n:{messages:{fr:{},en:{}}},created(){},mounted(){if(this.$eventHub.$on("carousel.next",this.nextFile),this.$eventHub.$on("carousel.prev",this.prevFile),this.$route.query.slide!==void 0){const s=parseInt(this.$route.query.slide,10)-1;!isNaN(s)&&s>=0&&s<this.files.length&&(this.active_file_index=s)}this.can_be_selected==="single"&&this.$emit("selectMedia",this.current_file_shown)},beforeDestroy(){this.$eventHub.$off("carousel.next",this.nextFile),this.$eventHub.$off("carousel.prev",this.prevFile)},watch:{active_file_index(s){if(s!==!1&&s!==null&&s!==void 0){const t={...this.$route.query};t.slide=(s+1).toString(),this.$router.replace({query:t}).catch(()=>{})}this.$nextTick(()=>{const t=this.$el.querySelector("._preview[data-iscurrent]");t&&t.scrollIntoView({behavior:"smooth",block:"center",inline:"center"})})},"$route.query.slide"(s){if(s!==void 0){const t=parseInt(s,10)-1;!isNaN(t)&&t>=0&&t<this.files.length&&this.active_file_index!==t&&(this.active_file_index=t)}}},computed:{boxid(){return"selectinputid-"+this.files.map(s=>s.$path).join("-")},enable_drag(){return typeof this.$eventHub._events["mediatile.drag.end"]<"u"},current_file_shown(){return this.active_file_index!==!1?this.files[this.active_file_index]:!1},file_shown_position(){return this.files.length===1?"alone":this.active_file_index===0?"first":this.active_file_index===this.files.length-1?"last":"inbetween"}},methods:{toggleFile(s){this.active_file_index===s?this.active_file_index=!1:this.active_file_index=s},openFile(s){this.active_file_index=s},prevFile(){this.active_file_index>0&&this.active_file_index--},nextFile(){this.active_file_index<this.files.length-1&&this.active_file_index++}}};var D=function(){var t=this,e=t._self._c;return e("div",{staticClass:"_stackCarousel"},[!t.files||t.files.length===0?[e("div",{staticClass:"u-instructions _nothingToShow"},[t._v(" "+t._s(t.$t("nothing_to_show"))+" ")])]:t._e(),t.current_file_shown?e("FileShown",{key:t.current_file_shown.$path,staticClass:"_stackCarousel--fileshown",attrs:{file:t.current_file_shown,position:t.file_shown_position,can_edit:t.can_edit}}):t._e(),e("transition-group",{staticClass:"_list",attrs:{tag:"div",name:"listComplete"}},t._l(t.files,function(i,a){return e("div",{key:i.$path,staticClass:"_preview",attrs:{"data-iscurrent":t.current_file_shown.$path===i.$path},on:{click:function(o){return t.openFile(a)}}},[e("MediaContent",{staticClass:"_preview--media",attrs:{file:i,context:"preview",resolution:360}}),t.can_be_selected==="multiple"?e("div",{staticClass:"_selectCheckbox"},[e("label",{attrs:{for:t.boxid}},[e("input",{attrs:{type:"checkbox",id:t.boxid,name:t.boxid},domProps:{checked:t.selected_files&&t.selected_files.some(o=>o.$path===i.$path)},on:{change:function(o){return t.$emit("toggleMediaSelection",i,o.target.checked)},click:function(o){o.stopPropagation()}}})])]):t.can_be_selected==="single"?e("div",{staticClass:"_selectRadio"},[e("label",{attrs:{for:t.boxid}},[e("input",{attrs:{type:"radio",id:t.boxid,name:t.boxid},domProps:{checked:t.current_file_shown.$path===i.$path},on:{change:function(o){return t.$emit("selectMedia",i)},click:function(o){o.stopPropagation()}}})])]):t._e(),e("transition",{attrs:{name:"fade",mode:"out-in"}},[t.current_file_shown.$path===i.$path?e("div",{staticClass:"_btnRow"},[e("div",{staticClass:"_previewOverlay"}),e("select",{staticClass:"_changeOrderSelect",attrs:{size:"small"},domProps:{value:a+1},on:{change:function(o){return t.$emit("changeMediaOrder",a,+o.target.value-1)}}},t._l(new Array(t.files.length).fill(null),function(o,n){return e("option",{key:n+1,domProps:{textContent:t._s(n+1)}})}),0),e("RemoveMenu",{staticClass:"_removeBtn",attrs:{remove_text:t.$t("remove"),show_button_text:!1},on:{remove:function(o){return t.$emit("removeMediaFromStack",t.current_file_shown.$path)}}})],1):t._e()]),e("div",{staticClass:"_credits"},[i.caption?e("b-icon",{attrs:{icon:"text-left"}}):t._e(),i.$credits?e("b-icon",{attrs:{icon:"info-circle"}}):t._e()],1)],1)}),0)],2)},q=[],P=r(T,D,q,!1,null,"60e04a2f");const j=P.exports,R={props:{stack:{type:Object,required:!0}},components:{DestinationCorpusSelector:w},data(){return{selected_destination_folder_path:"",new_title:this.stack.title,remove_original:!1,is_copying:!1}},i18n:{messages:{fr:{new_title:"Nouveau titre",duplicate_stack:"Dupliquer ou déplacer la pile",destination_corpus:"Corpus de destination"},en:{new_title:"New title",duplicate_stack:"Duplicate or move the stack",destination_corpus:"Destination corpus"}}},created(){},mounted(){},beforeDestroy(){},watch:{},computed:{},methods:{async duplicateOrMoveStack(){this.is_copying=!0,await this.$api.copyFolder({path:this.stack.$path,path_to_destination_type:this.selected_destination_folder_path+"/stacks",is_copy_or_move:this.remove_original?"move":"copy",new_meta:{title:this.new_title}}),this.remove_original&&await this.$api.deleteItem({path:this.stack.$path}),this.is_copying=!1}}};var O=function(){var t=this,e=t._self._c;return e("BaseModal2",{attrs:{title:t.$t("duplicate_stack")},on:{close:function(i){return t.$emit("close")}},scopedSlots:t._u([{key:"footer",fn:function(){return[e("div"),e("button",{staticClass:"u-button u-button_bleuvert",attrs:{type:"button",disabled:t.is_copying},on:{click:t.duplicateOrMoveStack}},[t.remove_original?[t._v(" "+t._s(t.$t("move"))+" ")]:[t._v(" "+t._s(t.$t("duplicate"))+" ")]],2),t.is_copying?e("LoaderSpinner"):t._e()]},proxy:!0}])},[e("div",{staticClass:"u-spacingBottom"},[e("DLabel",{attrs:{str:t.$t("new_title")}}),e("TextInput",{ref:"titleInput",attrs:{content:t.new_title,required:!0},on:{"update:content":function(i){t.new_title=i}}}),e("div",{staticClass:"u-spacingBottom"}),e("div",{},[e("DLabel",{attrs:{str:t.$t("destination_corpus")}}),e("DestinationCorpusSelector",{attrs:{selected_destination_folder_path:t.selected_destination_folder_path},on:{"update:selected_destination_folder_path":function(i){t.selected_destination_folder_path=i}}})],1),e("div",{staticClass:"u-spacingBottom"}),e("div",[e("ToggleInput",{attrs:{content:t.remove_original,label:t.$t("remove_original"),options:{true:t.$t("remove_original_after_copy"),false:t.$t("keep_original_after_copy")}},on:{"update:content":function(i){t.remove_original=i}}})],1)],1)])},E=[],N=r(R,O,E,!1,null,"9f1e8437");const K=N.exports,H={props:{stack_path:String,context:String,is_favorite:Boolean,can_be_added_to_fav:Boolean,can_be_selected:[Boolean,String],read_only:Boolean},components:{KeywordsField:g,StackCarousel:j,DuplicateStackModal:K,TwoColumnLayout:_},inject:{},data(){return{stack:void 0,fetch_stack_error:void 0,is_loading:!0,show_sidebar:localStorage.getItem("show_sidebar")!=="false",selected_stack_files:[],show_duplicate_stack_modal:!1}},i18n:{messages:{fr:{fill_title:"Veuillez remplir le champ Titre",fill_keywords:"Veuillez remplir le champ Mots-clés",files_missing:"Veuillez ajouter des médias à ce document",stack_not_public:"Ce document n'est pas public",error_loading_stack:"Erreur lors du chargement du document",select_stack:"Ajouter à ce document",add_selected_medias:"Ajouter le média sélectionné | Ajouter les {count} médias sélectionnés"},en:{fill_title:"Fill in the title field",fill_keywords:"Fill in the keywords field",files_missing:"Add medias to this document",stack_not_public:"This document is not public",error_loading_stack:"Error loading document",select_stack:"Add to this document",add_selected_medias:"Add selected media | Add the selected {count} medias"}}},async created(){var s;if(this.stack=await this.$api.getFolder({path:this.stack_path}).catch(t=>{this.is_loading=!1,t.code==="folder_private"?this.fetch_stack_error=this.$t("stack_not_public"):this.fetch_stack_error=this.$t("error_loading_stack")}),this.$api.join({room:this.stack.$path}),this.is_loading=!1,this.date_created_corrected=this.datetimeLocal(this.stack.date_created_corrected||this.stack.$date_created||this.stack.$date_uploaded),this.stack_files_in_order.length>0){const t=this.stack_files_in_order[0].$path;((s=this.stack.$preview)==null?void 0:s.$path)!==t&&await this.$api.updateMeta({path:this.stack.$path,new_meta:{$preview:this.getFilename(t)}})}},mounted(){window.addEventListener("keyup",this.handleKeyPress)},beforeDestroy(){window.removeEventListener("keyup",this.handleKeyPress),this.stack&&this.$api.leave({room:this.stack.$path})},watch:{"stack.date_created_corrected"(){this.date_created_corrected=this.datetimeLocal(this.stack.date_created_corrected)},show_sidebar(){localStorage.setItem("show_sidebar",this.show_sidebar)}},computed:{can_edit(){return!this.stack||this.read_only?!1:this.canLoggedinEditFolder({folder:this.stack})},stack_files_in_order(){return this.getStackFilesInOrder({stack:this.stack})},share_button_is_enabled(){var s,t;return((s=this.stack.title)==null?void 0:s.length)>0&&((t=this.stack.keywords)==null?void 0:t.length)>0&&this.stack_files_in_order.length>0}},methods:{addSelectedMedia(){this.$emit("selectMedias",this.selected_stack_files)},addSelectedMedias(){this.$emit("selectMedias",this.selected_stack_files)},selectMedia(s){this.selected_stack_files=[s]},async changeMediaOrder(s,t){var o,n;let e=this.stack_files_in_order.map(l=>this.getFilename(l.$path));function i(l,d,c){if(c>=l.length)for(var u=c-l.length+1;u--;)l.push(void 0);return l.splice(c,0,l.splice(d,1)[0]),l}i(e,s,t);let a={stack_files_metas:e};(!((o=this.stack.$preview)!=null&&o.$path)||this.getFilename((n=this.stack.$preview)==null?void 0:n.$path)!==e.at(0))&&(a.$preview=e.at(0)),await this.$api.updateMeta({path:this.stack.$path,new_meta:a})},async removeMediaFromStack(s){var e;await this.$api.copyFile({path:s,path_to_destination_folder:this.connected_as.$path,new_meta:{}}),await this.$api.deleteItem({path:s});let t=(e=this.stack)==null?void 0:e.stack_files_metas.slice();t=t.filter(i=>i!==this.getFilename(s)),await this.$api.updateMeta({path:this.stack.$path,new_meta:{stack_files_metas:t}})},async removeStack(){await this.$api.deleteItem({path:this.stack.$path}),this.$emit("close")},closeOnRemove({path:s}){s===this.stack.$path&&(this.$alertify.closeLogOnClick(!0).delay(4e3).log(this.$t("stack_was_removed")),this.$emit("close"))},handleKeyPress(s){if(s.key==="Escape")return this.$emit("close"),!1;s.key==="ArrowLeft"?this.$eventHub.$emit("carousel.prev"):s.key==="ArrowRight"?this.$eventHub.$emit("carousel.next"):s.key==="ArrowUp"?this.$eventHub.$emit("fileshown.showInfos"):s.key==="ArrowDown"&&this.$eventHub.$emit("fileshown.hideInfos")},handleToggleMediaSelection(s,t){t?this.selected_stack_files.some(e=>e.$path===s.$path)||(this.selected_stack_files=[...this.selected_stack_files,s]):this.selected_stack_files=this.selected_stack_files.filter(e=>e.$path!==s.$path),this.$emit("updateSelectedStackMedias",this.selected_stack_files)},selectAllMedias(){this.selected_stack_files=JSON.parse(JSON.stringify(this.stack_files_in_order))}}};var J=function(){var t=this,e=t._self._c;return e("div",{staticClass:"_stackDisplay",attrs:{"data-context":t.context}},[e("div",{staticClass:"_closeStack"},[e("button",{staticClass:"u-button u-button_icon u-button_transparent",on:{click:function(i){return t.$emit("close")}}},[e("b-icon",{attrs:{icon:"x-lg",label:t.$t("close")}})],1)]),e("div",{staticClass:"_panes"},[t.is_loading?e("LoaderSpinner"):t.fetch_stack_error?e("div",[t._v(" "+t._s(t.fetch_stack_error)+" ")]):e("TwoColumnLayout",{staticClass:"_stackDisplayLayout",attrs:{"show-sidebar":t.show_sidebar,"show-toggle-button":!0,"content-padding":!1},on:{"update:showSidebar":function(i){t.show_sidebar=i},"update:show-sidebar":function(i){t.show_sidebar=i}},scopedSlots:t._u([{key:"sidebar",fn:function(){return[e("div",{staticClass:"_infos"},[e("div",{staticClass:"_allFields"},[e("div",{staticClass:"_titleRow"},[e("TitleField",{attrs:{label:t.$t("title"),field_name:"title",content:t.stack.title,path:t.stack.$path,required:!0,tag:"h1",can_edit:t.can_edit}}),t.can_be_added_to_fav?e("button",{staticClass:"u-button u-button_icon _addToColl",attrs:{type:"button"},on:{click:function(i){return i.stopPropagation(),t.$emit("toggleFav")}}},[t.is_favorite?e("b-icon",{attrs:{icon:"star-fill","aria-label":t.$t("remove")}}):e("b-icon",{attrs:{icon:"star","aria-label":t.$t("add")}})],1):t._e()],1),e("hr"),e("div",[e("CollaborativeEditor3",{attrs:{label:t.$t("description"),field_to_edit:"description",content:t.stack.description,path:t.stack.$path,custom_formats:["bold","italic","link"],is_collaborative:!1,can_edit:t.can_edit}})],1),e("hr"),e("div",{},[e("KeywordsField",{attrs:{label:t.$t("keywords"),field_name:"keywords",keywords:t.stack.keywords,path:t.stack.$path,can_edit:t.can_edit}})],1),e("hr"),e("PositionPicker",{attrs:{field_name:"$location",label:t.$t("location"),content:t.stack.$location,path:t.stack.$path,can_edit:t.can_edit}}),e("hr"),e("div",{staticClass:"_dateFields"},[e("div",{},[e("DateField",{attrs:{label:t.$t("created"),field_name:"date_created_corrected",date:t.date_created_corrected,path:t.stack.$path,input_type:"datetime-local",can_edit:t.can_edit}})],1),e("div",{},[e("DateField",{attrs:{label:t.$t("date_modified"),field_name:"date_modified",date:t.stack.$date_modified,path:t.stack.$path,input_type:"datetime-local",can_edit:!1}})],1)]),e("hr"),e("div",{staticClass:"u-spacingBottom"},[e("AuthorField",{attrs:{label:t.$t("authors"),field:"$admins",instructions:t.$t("media_editing_instructions"),authors_paths:t.stack.$admins,path:t.stack.$path,can_edit:t.can_edit}})],1),e("div",{staticClass:"u-spacingBottom"},[e("AuthorField",{attrs:{label:t.$t("authors")+"(legacy)",field:"$authors",instructions:t.$t("media_editing_instructions"),authors_paths:t.stack.$admins,path:t.stack.$path,can_edit:t.can_edit}})],1),t.is_instance_admin?e("div",{},[t.can_edit?e("StatusTag",{attrs:{status:t.stack.$status||"public",status_options:["public","private"],path:t.stack.$path,can_edit:t.can_edit}}):t._e()],1):t._e(),e("hr"),t.can_edit?e("div",{staticClass:"u-sameRow"},[e("DownloadFolder",{attrs:{path:t.stack.$path}}),e("button",{staticClass:"u-buttonLink",attrs:{type:"button"},on:{click:function(i){i.stopPropagation(),t.show_duplicate_stack_modal=!0}}},[e("b-icon",{attrs:{icon:"file-plus"}}),t._v(" "+t._s(t.$t("duplicate_or_move"))+" ")],1),e("RemoveMenu",{attrs:{remove_text:t.$t("remove"),remove_expl:t.$t("remove_stack_instr")},on:{remove:t.removeStack}})],1):t._e()],1),t.context==="chutier"?e("div",{staticClass:"_bottomBtns"},[e("div",{staticClass:"u-instructions"},[!t.stack.title||t.stack.title.length===0?e("div",[t._v(" "+t._s(t.$t("fill_title"))+" ")]):t._e(),!t.stack.keywords||t.stack.keywords.length===0?e("div",[t._v(" "+t._s(t.$t("fill_keywords"))+" ")]):t._e(),t.stack_files_in_order.length===0?e("div",[t._v(" "+t._s(t.$t("files_missing"))+" ")]):t._e()])]):t._e()])]},proxy:!0},{key:"content",fn:function(){return[e("StackCarousel",{staticClass:"_topCarousel",attrs:{files:t.stack_files_in_order,can_edit:t.can_edit,can_be_selected:t.can_be_selected,selected_files:t.selected_stack_files},on:{toggleMediaSelection:t.handleToggleMediaSelection,selectMedia:t.selectMedia,removeMediaFromStack:t.removeMediaFromStack,changeMediaOrder:t.changeMediaOrder}})]},proxy:!0}])})],1),t.can_be_selected==="single_stack"?e("div",{staticClass:"_selectBar"},[e("button",{staticClass:"u-button",attrs:{type:"button"},on:{click:function(i){return t.$emit("selectStack")}}},[t._v(" "+t._s(t.$t("select_stack"))+" ")])]):t._e(),t.can_be_selected==="single"?e("div",{staticClass:"_selectBar"},[e("button",{staticClass:"u-button",attrs:{type:"button"},on:{click:t.addSelectedMedia}},[t._v(" "+t._s(t.$t("select_media"))+" ")])]):t._e(),t.can_be_selected==="multiple"?e("div",{staticClass:"_selectBar"},[e("button",{staticClass:"u-buttonLink",attrs:{type:"button",disabled:t.selected_stack_files.length===t.stack_files_in_order.length},on:{click:t.selectAllMedias}},[t._v(" "+t._s(t.$t("select_all"))+" ")]),e("button",{staticClass:"u-button",attrs:{type:"button",disabled:t.selected_stack_files.length===0},on:{click:t.addSelectedMedias}},[t._v(" "+t._s(t.$tc("add_selected_medias",t.selected_stack_files.length,{count:t.selected_stack_files.length}))+" ")])]):t._e(),t.show_duplicate_stack_modal?e("DuplicateStackModal",{attrs:{stack:t.stack},on:{close:function(i){t.show_duplicate_stack_modal=!1}}}):t._e()],1)},V=[],z=r(H,J,V,!1,null,"ae007f06");const G=z.exports,U={props:{current_corpus_path:{type:String,default:""}},components:{BaseModal2:f,LoaderSpinner:p},data(){return{path:"folders",folders:void 0,shared_folder_path:this.current_corpus_path,new_corpus_name:"",is_creating_corpus:!1}},i18n:{messages:{fr:{access_corpus:"Accéder à un corpus",corpus:"Corpus",select_corpus:"– sélectionner un corpus –",new_corpus:"nouveau corpus",new_corpus_name:"Nom du corpus",untitled:"Sans titre",open:"Ouvrir",create:"Créer"},en:{access_corpus:"Access a corpus",corpus:"Corpus",select_corpus:"– select a corpus –",new_corpus:"new corpus",new_corpus_name:"Corpus name",untitled:"Untitled",open:"Open",create:"Create"}}},async created(){await this.loadFolders(),this.$api.join({room:this.path})},beforeDestroy(){this.$api.leave({room:this.path})},methods:{async loadFolders(){this.folders=await this.$api.getFolders({path:this.path}).catch(s=>{this.fetch_spaces_error=s.response})},openFolder(){const s=this.shared_folder_path;this.$emit("changeCorpus",s)},async createCorpus(){this.is_creating_corpus=!0;const s=await this.$api.createFolder({path:this.path,additional_meta:{title:this.new_corpus_name,$admins:"everyone"}});setTimeout(()=>{this.shared_folder_path="folders/"+s,this.is_creating_corpus=!1},1e3)}}};var Z=function(){var t=this,e=t._self._c;return e("BaseModal2",{attrs:{title:t.$t("access_corpus")},on:{close:function(i){return t.$emit("close")}}},[e("div",{staticClass:"_corpusMenu"},[t.folders?[e("div",{staticClass:"_selectFolder"},[e("div",[e("label",{attrs:{for:"shared_folder_path"}},[t._v(" "+t._s(t.$t("access_corpus"))+" ")]),e("select",{directives:[{name:"model",rawName:"v-model",value:t.shared_folder_path,expression:"shared_folder_path"}],on:{change:function(i){var a=Array.prototype.filter.call(i.target.options,function(o){return o.selected}).map(function(o){var n="_value"in o?o._value:o.value;return n});t.shared_folder_path=i.target.multiple?a:a[0]}}},[e("option",{attrs:{value:""}},[t._v(t._s(t.$t("select_corpus")))]),t._l(t.folders,function(i){return e("option",{key:i.$path,domProps:{value:i.$path}},[t._v(" "+t._s(i.title||t.$t("untitled"))+" ")])}),e("option",{attrs:{value:"new"}},[t._v("+ "+t._s(t.$t("new_corpus")))])],2),e("div",{staticClass:"u-spacingBottom"}),t.shared_folder_path==="new"?e("div",{staticClass:"u-spacingBottom"},[e("TextInput",{attrs:{content:t.new_corpus_name,placeholder:t.$t("new_corpus_name"),required:!0,input_type:"text",maxlength:30},on:{"update:content":function(i){t.new_corpus_name=i}}})],1):t._e(),e("div",{staticClass:"_btnRow"},[e("div"),t.shared_folder_path!=="new"?e("button",{staticClass:"u-button",attrs:{type:"button",disabled:!t.shared_folder_path},on:{click:t.openFolder}},[t._v(" "+t._s(t.$t("open"))+" ")]):t.shared_folder_path==="new"?e("button",{staticClass:"u-button",attrs:{type:"button",disabled:!t.new_corpus_name||t.is_creating_corpus},on:{click:t.createCorpus}},[t._v(" "+t._s(t.$t("create"))+" ")]):t._e()]),t.is_creating_corpus?e("div",[e("LoaderSpinner")],1):t._e()])])]:e("LoaderSpinner")],2)])},X=[],Q=r(U,Z,X,!1,null,"891f78df");const W=Q.exports,Y={props:{all_folders:{type:Array,default:()=>[]},active_folder_paths:{type:Array,default:()=>[]},search_str:{type:String,default:""},show_filter_bar:{type:Boolean,default:!1},stack_preview_width:{type:Number,default:120},view_mode:{type:String,default:"list"}},components:{SearchInput2:m},i18n:{messages:{fr:{all_communities:"Communautés",untitled:"Sans titre",see_all_communities:"Voir toutes les communautés",search_fields:"Rechercher dans les champs titre et description des documents.",toggle_filters:"Afficher/masquer les filtres",list_view:"Vue liste",favorites_view:"Vue favoris",map_view:"Vue carte"},en:{all_communities:"Communities",untitled:"Untitled",see_all_communities:"See all communities",search_fields:"Search in titles or descriptions of documents.",toggle_filters:"Toggle filters",list_view:"List view",favorites_view:"Favorites view",map_view:"Map view"}}},computed:{isCommunityActive(){return s=>this.active_folder_paths.includes(s)}}};var tt=function(){var t=this,e=t._self._c;return e("div",{staticClass:"_topBar"},[e("div",{staticClass:"_communautesSection"},[e("div",{staticClass:"_communautesLabel"},[e("DLabel",{attrs:{str:t.$t("all_communities")}}),e("button",{staticClass:"u-button u-button_icon u-button_transparent _addCommunityButton",attrs:{type:"button",title:t.$t("see_all_communities")},on:{click:function(i){return t.$router.push("/explore")}}},[e("b-icon",{attrs:{icon:"list"}})],1)],1),e("div",{staticClass:"_corpusItems"},t._l(t.all_folders,function(i){return e("button",{key:i.$path,staticClass:"u-button u-button_pill u-button_white _corpusItem",class:{"is--active":t.isCommunityActive(i.$path)},attrs:{type:"button"},on:{click:function(a){return t.$emit("toggleCorpus",i.$path)}}},[t._v(" "+t._s(i.title||t.$t("untitled"))+" ")])}),0)]),e("div",{staticClass:"_topBarContent"},[e("div",{staticClass:"_searchBar"},[e("SearchInput2",{staticClass:"_searchInput",attrs:{value:t.search_str,search_placeholder:t.$t("search_fields")},on:{input:function(i){return t.$emit("update:search_str",i)}}}),e("button",{staticClass:"u-button u-button_icon u-button_transparent _filterToggle",class:{"is--active":t.show_filter_bar},attrs:{type:"button",title:t.$t("toggle_filters")},on:{click:function(i){return t.$emit("update:show_filter_bar",!t.show_filter_bar)}}},[e("b-icon",{attrs:{icon:"sliders"}})],1)],1),e("div",{staticClass:"_topBarControls"},[e("div",{staticClass:"_displayOptions"},[e("div",{staticClass:"_zoomSlider"},[e("button",{staticClass:"u-button u-button_icon u-button_transparent",attrs:{type:"button"},on:{click:function(i){t.$emit("update:stack_preview_width",Math.max(50,t.stack_preview_width-10))}}},[e("b-icon",{attrs:{icon:"dash"}})],1),e("input",{staticClass:"_inputRange",attrs:{type:"range",min:"50",max:"250",step:"5"},domProps:{value:t.stack_preview_width},on:{input:function(i){return t.$emit("update:stack_preview_width",+i.target.value)}}}),e("button",{staticClass:"u-button u-button_icon u-button_transparent",attrs:{type:"button"},on:{click:function(i){t.$emit("update:stack_preview_width",Math.min(250,t.stack_preview_width+10))}}},[e("b-icon",{attrs:{icon:"plus"}})],1)]),e("div",{staticClass:"_viewModeButtons"},[e("button",{staticClass:"u-button u-button_icon",class:{"is--active":t.view_mode==="list"},attrs:{type:"button",title:t.$t("list_view")},on:{click:function(i){return t.$emit("update:view_mode","list")}}},[e("b-icon",{attrs:{icon:"grid3x3"}})],1),e("button",{staticClass:"u-button u-button_icon",class:{"is--active":t.view_mode==="fav"},attrs:{type:"button",title:t.$t("favorites_view")},on:{click:function(i){return t.$emit("update:view_mode","fav")}}},[e("svg",{attrs:{width:"16",height:"16",viewBox:"0 0 16 16",xmlns:"http://www.w3.org/2000/svg"}},[e("path",{attrs:{d:"M7.38174 1.75501C7.59507 1.19234 8.40241 1.19234 8.61641 1.75501L9.99641 5.57767C10.0931 5.83101 10.3391 5.99967 10.6137 5.99967H14.0051C14.6317 5.99967 14.9051 6.77967 14.4124 7.16167L11.9991 9.33301C11.891 9.41611 11.812 9.53132 11.7734 9.66211C11.7348 9.7929 11.7387 9.93255 11.7844 10.061L12.6657 13.7963C12.8804 14.3963 12.1857 14.9117 11.6604 14.5423L8.38241 12.4623C8.27015 12.3834 8.13628 12.3411 7.99907 12.3411C7.86187 12.3411 7.728 12.3834 7.61574 12.4623L4.33774 14.5423C3.81307 14.9117 3.11774 14.3957 3.33241 13.7963L4.21374 10.061C4.25946 9.93255 4.26331 9.7929 4.22475 9.66211C4.18618 9.53132 4.10718 9.41611 3.99907 9.33301L1.58574 7.16167C1.09241 6.77967 1.36707 5.99967 1.99241 5.99967H5.38374C5.51727 6.00012 5.64778 5.96001 5.75802 5.88466C5.86825 5.8093 5.95301 5.70225 6.00107 5.57767L7.38107 1.75501H7.38174Z","stroke-linecap":"round","stroke-linejoin":"round"}})])]),e("button",{staticClass:"u-button u-button_icon",class:{"is--active":t.view_mode==="map"},attrs:{type:"button",title:t.$t("map_view")},on:{click:function(i){return t.$emit("update:view_mode","map")}}},[e("b-icon",{attrs:{icon:"map-fill"}})],1)])])])])])},et=[],st=r(Y,tt,et,!1,null,"7c19d489");const it=st.exports,at={props:{shared_folder_paths:{type:Array,default:()=>[]},select_mode:{type:[Boolean,String],default:!1},read_only:Boolean},components:{FilterBar:x,StackPreview:I,StackDisplay:G,CorpusMenu:W,TwoColumnLayout:_,ArchiveTopBar:it,MediaMap:()=>v(()=>import("./MediaMap-CP2wt0Bg.js"),[])},data(){return{folder:void 0,all_folders:[],all_stacks:[],show_corpus_menu:!1,is_loading_folder:!0,show_admin_settings:!1,last_selected_stack_path:void 0,view_mode:localStorage.getItem("archive.view_mode")||"list",sort_order:localStorage.getItem("archive.sort_order")||"date_created",search_str:localStorage.getItem("archive.search_str")||"",author_path_filter:localStorage.getItem("archive.author_path_filter")||"",keywords_filter:JSON.parse(localStorage.getItem("archive.keywords_filter")||"[]"),group_mode:localStorage.getItem("archive.group_mode")||"year",selected_medias_paths:[],stack_preview_width:parseInt(localStorage.getItem("archive.stack_preview_width"))||120,show_filter_bar:localStorage.getItem("archive.show_filter_bar")==="true",joined_rooms:new Set}},i18n:{messages:{fr:{corpus_title:"Titre du corpus"},en:{corpus_title:"Corpus title"}}},async created(){},async mounted(){await this.checkExistingFolder();const s=this.active_folder_paths[0];s&&(localStorage.setItem("last_opened_folder_path",s),this.folder=await this.$api.getFolder({path:s})),this.all_folders=await this.$api.getFolders({path:"folders"}),await this.loadStacksFromCommunities(),this.active_folder_paths.forEach(t=>{this.joinRoom(t),this.joinRoom(t+"/stacks")}),this.is_loading_folder=!1},beforeDestroy(){this.active_folder_paths.forEach(s=>{this.$api.leave({room:s}),this.$api.leave({room:s+"/stacks"})})},watch:{opened_stack(){this.opened_stack&&(this.last_selected_stack_path=this.opened_stack.$path)},active_folder_paths:{async handler(s,t){JSON.stringify(s)!==JSON.stringify(t)&&s.length>0&&(s.forEach(e=>{this.joinRoom(e),this.joinRoom(e+"/stacks")}),await this.loadStacksFromCommunities(),s[0]&&(this.folder=await this.$api.getFolder({path:s[0]})))},immediate:!1},sort_order(){localStorage.setItem("archive.sort_order",this.sort_order)},view_mode(){localStorage.setItem("archive.view_mode",this.view_mode)},search_str(){localStorage.setItem("archive.search_str",this.search_str)},author_path_filter(){localStorage.setItem("archive.author_path_filter",this.author_path_filter)},keywords_filter:{handler(s){localStorage.setItem("archive.keywords_filter",JSON.stringify(s))},deep:!0},group_mode(){localStorage.setItem("archive.group_mode",this.group_mode)},show_filter_bar(){localStorage.setItem("archive.show_filter_bar",this.show_filter_bar)},stack_preview_width(){localStorage.setItem("archive.stack_preview_width",this.stack_preview_width.toString())}},computed:{active_folder_paths(){return this.shared_folder_paths||[]},display_mode(){return this.stack_preview_width<120?"compact":""},can_edit(){return this.canLoggedinEditFolder({folder:this.folder})},stack_shared_folder_paths(){return this.active_folder_paths.map(s=>s+"/stacks")},can_be_added_to_fav(){var s;return this.connected_as&&((s=this.connected_as)==null?void 0:s.$path)!==void 0&&!this.read_only},sorted_stacks(){return this.all_stacks.slice().sort((s,t)=>+new Date(t.$date_modified)-+new Date(s.$date_modified))},stacks_without_keyword_filter(){return this.sorted_stacks.filter(s=>{var t;return this.view_mode==="fav"&&!this.isFavorite(s.$path)||this.author_path_filter&&!((t=s.$authors)!=null&&t.includes(this.author_path_filter))?!1:this.search_str?!!(s.title&&s.title.toLowerCase().includes(this.search_str.toLowerCase())||s.description&&s.description.toLowerCase().includes(this.search_str.toLowerCase())):!0})},filtered_stacks(){return this.sorted_stacks.filter(s=>{var t;return this.view_mode==="fav"&&!this.isFavorite(s.$path)||this.author_path_filter&&!((t=s.$authors)!=null&&t.includes(this.author_path_filter))||this.keywords_filter.length>0&&(!s.keywords||!Array.isArray(s.keywords)||!this.keywords_filter.every(e=>s.keywords.includes(e)))?!1:this.search_str?!!(s.title&&s.title.toLowerCase().includes(this.search_str.toLowerCase())||s.description&&s.description.toLowerCase().includes(this.search_str.toLowerCase())):!0})},grouped_stacks(){let s=["$date_modified"];return this.sort_order==="date_created"?s=["date_created_corrected","$date_created","$date_uploaded"]:this.sort_order==="date_modified"&&(s=["$date_modified"]),this.groupFilesBy(this.filtered_stacks,s,this.group_mode)},timeline_stacks(){let s=["date_created_corrected","$date_created","$date_uploaded"];return this.groupFilesBy(this.filtered_stacks,s,"day")},available_keywords(){return this.sorted_stacks.reduce((t,e)=>(e.keywords&&Array.isArray(e.keywords)&&e.keywords.map(i=>{const a=t.find(o=>o.title===i);a?a.count+=1:t.push({title:i,count:1})}),t),[]).sort((t,e)=>e.count-t.count)},valid_keywords(){return this.available_keywords.filter(s=>{if(this.keywords_filter.includes(s.title))return!0;const t=[...this.keywords_filter,s.title];return this.stacks_without_keyword_filter.some(e=>!e.keywords||!Array.isArray(e.keywords)?!1:t.every(i=>e.keywords.includes(i)))})},opened_stack(){var s;return(s=this.$route.query)!=null&&s.stack?this.all_stacks.find(t=>this.getFilename(t.$path)===this.$route.query.stack):!1}},methods:{async checkExistingFolder(){this.all_folders=await this.$api.getFolders({path:"folders"}),this.active_folder_paths.length>0&&(this.active_folder_paths.every(t=>this.all_folders.find(e=>e.$path===t))||this.$router.push({path:"/explore"}))},toggleMediaFocus(s){const t=this.getFilename(s);this.openStack(t)},openStack(s,t){let e=Object.assign({},this.$route.query)||{};e.stack=s,t!=null&&(e.slide=(t+1).toString()),this.$router.push({query:e})},isFavorite(s){var t;return!((t=this.connected_as)!=null&&t.favorites)||this.connected_as.favorites.length===0?!1:this.connected_as.favorites.some(e=>e.stack_path===s)},async toggleFav(s){var e;debugger;let t=(e=this.connected_as)!=null&&e.favorites?this.connected_as.favorites.slice():[];this.isFavorite(s)?t=t.filter(i=>i.stack_path!==s):t.push({stack_path:s,added:+new Date}),await this.$api.updateMeta({path:this.connected_as.$path,new_meta:{favorites:t}})},closeStack(){let s=Object.assign({},this.$route.query)||{};delete s.stack,this.$router.push({query:s})},toggleCorpus(s){this.$emit("toggleCorpus",s)},getFolderTitle(s){const t=this.all_folders.find(e=>e.$path===s);return t?t.title||this.$t("untitled"):this.$t("untitled")},joinRoom(s){this.joined_rooms.has(s)||(this.$api.join({room:s}),this.joined_rooms.add(s))},async loadStacksFromCommunities(){const s=this.stack_shared_folder_paths.map(i=>this.$api.getFolders({path:i})),t=await Promise.all(s),e=new Map;t.flat().forEach(i=>{e.has(i.$path)||e.set(i.$path,i)}),this.all_stacks=Array.from(e.values())}}};var ot=function(){var t=this,e=t._self._c;return e("div",{staticClass:"_sharedFolder"},[e("transition",{attrs:{name:"scaleInFade",mode:"out-in"}},[t.opened_stack?e("StackDisplay",{key:t.opened_stack.$path,staticClass:"_stackModal",attrs:{stack_path:t.opened_stack.$path,context:"archive",can_be_added_to_fav:t.can_be_added_to_fav,can_be_selected:t.select_mode,is_favorite:t.isFavorite(t.opened_stack.$path),read_only:t.read_only},on:{toggleFav:function(i){return t.toggleFav(t.opened_stack.$path)},prevMedia:function(i){return t.navMedia(-1)},nextMedia:function(i){return t.navMedia(1)},selectStack:function(i){return t.$emit("selectStack",t.opened_stack)},selectMedias:function(i){return t.$emit("selectMedias",i)},close:t.closeStack}}):t._e()],1),e("transition",{attrs:{name:"fade_fast",mode:"out-in"}},[t.is_loading_folder?e("div",{staticClass:"_loader"},[e("LoaderSpinner")],1):e("TwoColumnLayout",{staticClass:"_sharedFolder--content",attrs:{"show-sidebar":t.show_filter_bar,"show-toggle-button":!1},on:{"update:showSidebar":function(i){t.show_filter_bar=i},"update:show-sidebar":function(i){t.show_filter_bar=i}},scopedSlots:t._u([{key:"sidebar",fn:function(){return[e("FilterBar",{attrs:{group_mode:t.group_mode,sort_order:t.sort_order,author_path_filter:t.author_path_filter,available_keywords:t.valid_keywords,keywords_filter:t.keywords_filter},on:{"update:group_mode":function(i){t.group_mode=i},"update:sort_order":function(i){t.sort_order=i},"update:author_path_filter":function(i){t.author_path_filter=i},"update:keywords_filter":function(i){t.keywords_filter=i}}})]},proxy:!0},{key:"content",fn:function(){return[e("ArchiveTopBar",{attrs:{all_folders:t.all_folders,active_folder_paths:t.active_folder_paths,search_str:t.search_str,show_filter_bar:t.show_filter_bar,stack_preview_width:t.stack_preview_width,view_mode:t.view_mode},on:{"update:search_str":function(i){t.search_str=i},"update:show_filter_bar":function(i){t.show_filter_bar=i},"update:stack_preview_width":function(i){t.stack_preview_width=i},"update:view_mode":function(i){t.view_mode=i},toggleCorpus:t.toggleCorpus}}),e("transition",{attrs:{name:"fade",mode:"out-in"}},[e("div",{key:t.sort_order+"-"+t.group_mode,staticClass:"_stacksList"},[t.grouped_stacks.length===0?e("div",{staticClass:"u-instructions _noContent"},[t._v(" "+t._s(t.$t("no_content"))+" ")]):[["list","fav"].includes(t.view_mode)?t._l(t.grouped_stacks,function({label:i,files:a}){return e("div",{key:i,staticClass:"_dayFileSection"},[e("div",{staticClass:"_label"},[t._v(" "+t._s(i)+" ")]),e("div",{staticClass:"_itemGrid",class:{"is--compact":t.display_mode==="compact"},style:{"--stack_preview_width":`${t.stack_preview_width}px`}},t._l(a,function(o){return e("StackPreview",{key:o.$path,attrs:{stack:o,display:t.display_mode,is_selected:o.$path===t.last_selected_stack_path,can_be_added_to_fav:t.can_be_added_to_fav,is_favorite:t.isFavorite(o.$path)},on:{toggleFav:function(n){return t.toggleFav(o.$path)},openStack:t.openStack}})}),1)])}):t.view_mode==="map"?e("div",{key:"mediaMap",staticClass:"_mediamapContainer"},[e("MediaMap",{attrs:{medias:t.filtered_stacks},on:{toggleMediaFocus:t.toggleMediaFocus}})],1):t._e()]],2)])]},proxy:!0}])})],1)],1)},rt=[],nt=r(at,ot,rt,!1,null,"3962ace9");const lt=nt.exports,ct={name:"CommunityPreview",props:{folder:{type:Object,required:!0},is_selected:{type:Boolean,default:!1}},components:{DropDown:$},i18n:{messages:{fr:{access_restricted:"Accès restreint",ask_to_join:"Demander à rejoindre",send_email_to_admins:"Envoyer un email aux administrateurs",email_instructions:"Les administrateurs recevront un email avec votre demande."}},en:{access_restricted:"Access restricted",ask_to_join:"Ask to join",send_email_to_admins:"Send email to admins",email_instructions:"The admins will receive an email with your request."}},data(){return{showAskToJoin:!1}},computed:{can_edit(){return this.canLoggedinEditFolder({folder:this.folder})},can_see(){return this.canLoggedinSeeFolder({folder:this.folder})},can_open_community(){return this.can_edit||this.can_see||this.folder.$status!=="private"}},methods:{mailtoLink(s){return`mailto:${s}`}}};var _t=function(){var t=this,e=t._self._c;return e("div",{staticClass:"_communityItem"},[e("div",{staticClass:"_communityHeader"},[e("div",{staticClass:"_communityTitle"},[e("TitleField",{attrs:{field_name:"title",label:t.$t("title"),show_label:!1,content:t.folder.title||"",path:t.folder.$path,can_edit:t.can_edit,tag:"div",maxlength:100}})],1),e("div",{staticClass:"_communityDescription"},[e("TitleField",{attrs:{field_name:"description",label:t.$t("description"),content:t.folder.description||"",path:t.folder.$path,can_edit:t.can_edit,show_label:!0,tag:"div",maxlength:500}})],1),e("div",{staticClass:"_communityAuthor"},[e("AdminsAndContributorsField",{attrs:{folder:t.folder,can_edit:t.can_edit,admin_label:t.$t("referent"),admin_instructions:t.$t("community_admin_instructions"),contrib_instructions:t.$t("community_contrib_instructions")}})],1)]),e("div",{staticClass:"_communityActions"},[t.can_edit?e("DropDown",{attrs:{show_label:!1,right:!0}},[e("button",{staticClass:"u-buttonLink",attrs:{type:"button"},on:{click:function(i){return i.stopPropagation(),t.$emit("remove",t.folder)}}},[e("b-icon",{attrs:{icon:"trash"}}),t._v(" "+t._s(t.$t("remove"))+" ")],1)]):t._e()],1),e("div",{staticClass:"_selectContainer"},[t.can_open_community?e("label",{staticClass:"_selectLabel",attrs:{for:t.folder.$path}},[e("span",{staticClass:"_selectText"},[t._v(t._s(t.$t("select")))]),e("input",{staticClass:"_checkbox",attrs:{type:"checkbox",id:t.folder.$path},domProps:{value:t.folder.$path,checked:t.is_selected},on:{change:function(i){return t.$emit("select",t.folder.$path,i.target.checked)}}})]):e("div",{staticClass:"_joinLabel"},[e("div",[t._v(t._s(t.$t("access_restricted")))]),t.folder.$admins&&t.folder.$admins.length>0?e("button",{staticClass:"u-button u-button_primary",attrs:{type:"button"},on:{click:function(i){t.showAskToJoin=!0}}},[t._v(" "+t._s(t.$t("ask_to_join"))+" ")]):t._e(),t.showAskToJoin?e("BaseModal2",{attrs:{title:t.$t("ask_to_join")},on:{close:function(i){t.showAskToJoin=!1}}},[e("div",{staticStyle:{"margin-bottom":"1.5em"}},[e("p",[t._v(" "+t._s(t.$t("send_email_to_admins"))+" ")]),e("ul",t._l(t.folder.$admins,function(i){return e("li",{key:i.email},[e("a",{attrs:{href:t.mailtoLink(i.email)}},[t._v(" "+t._s(i.email)+" ")])])}),0),e("p",[t._v(" "+t._s(t.$t("email_instructions"))+" ")])]),e("div",{staticStyle:{"text-align":"right"}},[e("button",{staticClass:"u-button",attrs:{type:"button"},on:{click:function(i){t.showAskToJoin=!1}}},[t._v(" "+t._s(t.$t("close"))+" ")])])]):t._e()],1)])])},dt=[],ut=r(ct,_t,dt,!1,null,"9d752287");const ht=ut.exports,pt={props:{shared_folder_paths:{type:Array,default:()=>[]},select_mode:{type:[Boolean,String],default:!1},read_only:{type:Boolean,default:!1},use_query:{type:Boolean,default:!0}},components:{SharedFolder2:lt,CommunityPreview:ht,CreateFolder:y},data(){return{all_folders:[],selected_folders:[],show_add_community:!1,community_to_remove:null}},async created(){},async mounted(){if(this.all_folders=await this.$api.getFolders({path:"folders"}),this.$api.join({room:"folders"}),this.use_query)if(this.$route&&this.$route.query&&this.$route.query.communities){const s=this.computed_shared_folder_paths;s.length>0&&(this.selected_folders=s.slice(),this.saveToLocalStorage(this.selected_folders))}else{const s=this.loadFromLocalStorage();if(s&&s.length>0){const t=s.filter(e=>this.all_folders.find(i=>i.$path===e));if(t.length>0){this.selected_folders=t;const e=t.map(i=>i.split("/").pop());this.$router.replace({path:this.$route.path,query:{communities:e.join(",")}})}}}else if(this.shared_folder_paths&&this.shared_folder_paths.length>0)this.selected_folders=this.shared_folder_paths.slice();else{const s=this.loadFromLocalStorage();if(s&&s.length>0){const t=s.filter(e=>this.all_folders.find(i=>i.$path===e));t.length>0&&(this.selected_folders=t,this.$nextTick(()=>{this.$emit("communitiesSelected",this.selected_folders)}))}}},beforeDestroy(){},watch:{computed_shared_folder_paths:{handler(s){this.use_query&&this.$route&&this.$route.query&&this.$route.query.communities&&(this.selected_folders=s?s.slice():[])},immediate:!0},shared_folder_paths:{handler(s){this.use_query||(this.selected_folders=s?s.slice():[])},immediate:!0},selected_folders:{handler(s){this.saveToLocalStorage(s)},deep:!0}},computed:{computed_shared_folder_paths(){return this.use_query?this.$route&&this.$route.query&&this.$route.query.communities?this.$route.query.communities.split(",").filter(Boolean).map(t=>`folders/${t.trim()}`):[]:this.shared_folder_paths||[]},hasSelectedCommunities(){return this.computed_shared_folder_paths&&this.computed_shared_folder_paths.length>0},available_folders_to_add(){return this.all_folders.filter(s=>!this.selected_folders.includes(s.$path))},displayed_folders(){return this.all_folders}},methods:{openSelectedCommunities(){if(this.selected_folders.length!==0)if(this.use_query){const s=this.selected_folders.map(t=>t.split("/").pop());this.$router.push({path:this.$route.path,query:{communities:s.join(",")}})}else this.$emit("communitiesSelected",this.selected_folders)},handleSelect(s,t){t?this.selected_folders.includes(s)||this.selected_folders.push(s):this.selected_folders=this.selected_folders.filter(e=>e!==s)},toggleCorpus(s){if(this.use_query){const t=s.split("/").pop(),e=this.computed_shared_folder_paths.map(o=>o.split("/").pop()),i=e.includes(t);let a;i?a=e.filter(o=>o!==t):a=[...e,t],a.length===0?this.$router.push({path:this.$route.path}):this.$router.push({path:this.$route.path,query:{communities:a.join(",")}})}else this.selected_folders.includes(s)?this.selected_folders=this.selected_folders.filter(e=>e!==s):this.selected_folders.push(s),this.$emit("communitiesSelected",this.selected_folders)},async onCommunityCreated(s){this.show_add_community=!1},addCommunity(s){if(this.selected_folders.includes(s)||this.selected_folders.push(s),this.show_add_community=!1,this.use_query){const t=this.selected_folders.map(e=>e.split("/").pop());this.$router.push({path:this.$route.path,query:{communities:t.join(",")}})}else this.$emit("communitiesSelected",this.selected_folders)},showRemoveModal(s){this.community_to_remove=s},async onCommunityRemoved(){if(this.all_folders=this.all_folders.filter(s=>s.$path!==this.community_to_remove.$path),this.selected_folders=this.selected_folders.filter(s=>s!==this.community_to_remove.$path),this.use_query){const s=this.computed_shared_folder_paths.map(i=>i.split("/").pop()),t=this.community_to_remove.$path.split("/").pop(),e=s.filter(i=>i!==t);e.length===0?this.$router.push({path:this.$route.path}):this.$router.push({path:this.$route.path,query:{communities:e.join(",")}})}else this.$emit("communityRemoved",this.community_to_remove.$path);this.community_to_remove=null},saveToLocalStorage(s){try{s&&s.length>0?localStorage.setItem("corpusManager.selected_communities",JSON.stringify(s)):localStorage.removeItem("corpusManager.selected_communities")}catch(t){console.warn("Failed to save selected communities to localStorage",t)}},loadFromLocalStorage(){try{const s=localStorage.getItem("corpusManager.selected_communities");if(s)return JSON.parse(s)}catch(s){console.warn("Failed to load selected communities from localStorage",s)}return null}}};var ft=function(){var t=this,e=t._self._c;return e("div",{staticClass:"_corpusManager"},[t.hasSelectedCommunities?e("SharedFolder2",{attrs:{shared_folder_paths:t.computed_shared_folder_paths,select_mode:t.select_mode,read_only:t.read_only},on:{toggleCorpus:t.toggleCorpus,selectStack:function(i){return t.$emit("selectStack",i)},selectMedias:function(i){return t.$emit("selectMedias",i)}}}):e("div",{staticClass:"_selectionView"},[e("div",{staticClass:"_header"},[e("h1",{staticClass:"_title"},[t._v(t._s(t.$t("Communautés")))]),e("div",{staticClass:"_headerActions"},[e("button",{staticClass:"u-button u-button_icon u-button_transparent _addCommunityButton",attrs:{type:"button",title:t.$t("add_community")},on:{click:function(i){t.show_add_community=!0}}},[e("b-icon",{attrs:{icon:"plus"}}),t._v(" "+t._s(t.$t("add_community"))+" ")],1)])]),e("div",{staticClass:"_communitiesList"},[t._l(t.displayed_folders,function(i){return e("CommunityPreview",{key:i.$path,attrs:{folder:i,is_selected:t.selected_folders.includes(i.$path)},on:{select:t.handleSelect,remove:t.showRemoveModal}})}),t.displayed_folders.length===0?e("div",{staticClass:"_noCommunities"},[t._v(" "+t._s(t.$t("no_communities_available"))+" ")]):t._e()],2),e("div",{staticClass:"_actions"},[e("button",{staticClass:"u-button u-button_primary",attrs:{type:"button",disabled:t.selected_folders.length===0},on:{click:t.openSelectedCommunities}},[t._v(" "+t._s(t.$t("open"))+" ")])])]),t.show_add_community?e("CreateFolder",{attrs:{modal_name:t.$t("add_community"),path:"folders"},on:{close:function(i){t.show_add_community=!1},openNew:t.onCommunityCreated}}):t._e(),t.community_to_remove?e("RemoveMenu2",{attrs:{path:t.community_to_remove.$path,modal_title:t.$t("remove_community"),modal_expl:t.$t("remove_community_explanation"),success_notification:t.$t("community_removed_successfully")},on:{close:function(i){t.community_to_remove=null},removedSuccessfully:t.onCommunityRemoved}}):t._e()],1)},mt=[],vt=r(pt,ft,mt,!1,null,"c52b8b54");const bt=vt.exports;export{bt as C};
